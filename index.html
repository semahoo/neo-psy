<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پلتفرم نئو-سای (نسخه ۱۶.۰)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js for Radar Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        .hidden { display: none; }
        .btn-spinner {
            display: inline-block; width: 1.25rem; height: 1.25rem;
            border: 2px solid rgba(255,255,255,0.5); border-radius: 50%;
            border-top-color: #fff; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-button.active {
            border-color: #0d9488; background-color: #ccfbf1; color: #134e4a;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8">

        <!-- Loading Screen -->
        <div id="loading-screen" class="text-center fade-in p-8">
             <div class="flex justify-center items-center mb-4">
                <svg class="animate-spin h-10 w-10 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">در حال بارگذاری...</h2>
            <p id="init-error" class="text-red-500 text-sm mt-4"></p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="hidden text-center fade-in">
            <header class="mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-teal-600">نئو-سای</h1>
                <p class="text-lg text-gray-500 mt-2">پلتفرم هوشمند تحلیل شخصیت</p>
            </header>
            <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">به "نئو-سای" خوش آمدید!</h2>
                <p id="welcome-error" class="text-red-500 text-sm mb-4"></p>
                <p class="text-gray-600 mb-6 leading-relaxed">
                   برای شروع ارزیابی شخصیت خود، لطفاً وارد حساب کاربری خود شوید یا یک حساب جدید بسازید.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="showScreen('login-screen')" class="w-full sm:w-auto bg-teal-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-teal-700 transition-all duration-300 shadow-md">
                        ورود با ایمیل
                    </button>
                    <button onclick="signInWithGoogle()" class="w-full sm:w-auto bg-white text-gray-700 font-bold py-3 px-10 rounded-lg hover:bg-gray-100 transition-all duration-300 shadow-md border flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="m43.611 20.083l-5.657 5.657C36.318 24.341 35.136 24 33.8 24h-9.8v8h9.8c4.667 0 8.86-3.111 10.241-7.583l.001-.001z"></path><path fill="#FBBC05" d="M12 24c0-2.235.566-4.363 1.558-6.22l-5.657-5.657C6.053 15.954 4 19.732 4 24s2.053 8.046 4.901 11.877l5.657-5.657C12.566 28.363 12 26.235 12 24z"></path><path fill="#EA4335" d="M24 48c5.268 0 10.046-1.947 13.611-5.123l-5.657-5.657C30.158 38.846 27.235 40 24 40c-5.218 0-9.651-3.341-11.303-8H2.901C5.954 39.947 14.268 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        ورود با گوگل
                    </button>
                </div>
            </main>
        </div>

        <!-- Registration Screen -->
        <div id="register-screen" class="hidden fade-in">
            <main class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200 max-w-md mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">ایجاد حساب کاربری</h2>
                <div class="space-y-4">
                    <input id="register-firstname" type="text" placeholder="نام" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <input id="register-lastname" type="text" placeholder="نام خانوادگی" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <input id="register-email" type="email" placeholder="ایمیل" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <input id="register-password" type="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <input id="register-age" type="number" placeholder="سن" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <select id="register-gender" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 bg-white">
                        <option value="" disabled selected>جنسیت خود را انتخاب کنید</option>
                        <option value="male">مرد</option>
                        <option value="female">زن</option>
                        <option value="other">ترجیح می‌دهم نگویم</option>
                    </select>
                </div>
                <p id="register-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                <button id="register-button" onclick="registerUser()" class="w-full mt-6 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700 transition-all flex items-center justify-center">ثبت نام</button>
                <p class="text-center mt-4 text-sm">حساب کاربری دارید؟ <a href="#" onclick="showScreen('login-screen')" class="text-teal-600 hover:underline">وارد شوید</a></p>
            </main>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden fade-in">
            <main class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200 max-w-md mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-900">ورود به حساب کاربری</h2>
                <div class="space-y-4">
                    <input id="login-email" type="email" placeholder="ایمیل" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <input id="login-password" type="password" placeholder="رمز عبور" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                </div>
                 <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                <button id="login-button" onclick="loginUser()" class="w-full mt-6 bg-teal-600 text-white font-bold py-3 rounded-lg hover:bg-teal-700 transition-all flex items-center justify-center">ورود</button>
                 <p class="text-center mt-4 text-sm">حساب کاربری ندارید؟ <a href="#" onclick="showScreen('register-screen')" class="text-teal-600 hover:underline">ثبت نام کنید</a></p>
            </main>
        </div>

        <!-- Test Screen -->
        <div id="test-screen" class="hidden fade-in">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-teal-600">آزمون شخصیت نئو (NEO-FFI)</h1>
                <button onclick="logoutUser()" class="text-sm text-red-500 hover:underline">خروج</button>
            </header>
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
                <div class="mb-6">
                    <p id="question-counter" class="text-center text-gray-500 mb-2"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-teal-500 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div id="question-container"></div>
                <div class="mt-8 text-center">
                    <button id="next-button" onclick="nextQuestion()" class="bg-teal-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-teal-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>بعدی</button>
                </div>
            </div>
        </div>

        <!-- Analyzing Screen -->
        <div id="analyzing-screen" class="hidden text-center fade-in p-8">
             <div class="flex justify-center items-center mb-4">
                <svg class="animate-spin h-10 w-10 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">در حال تحلیل نتایج...</h2>
            <p class="text-gray-500 mt-2">موتور هوش مصنوعی ما در حال آماده‌سازی گزارش شخصی شماست. این ممکن است چند لحظه طول بکشد.</p>
            <button onclick="cancelAnalysis()" class="mt-4 text-sm text-gray-500 hover:underline">لغو</button>
        </div>

        <!-- Profile Screen -->
        <div id="profile-screen" class="hidden fade-in">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-teal-600">پروفایل کاربری</h1>
                <button onclick="showScreen('results-screen')" class="text-sm text-gray-600 hover:underline">بازگشت به نتایج</button>
            </header>
            <main class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
                <!-- View Mode -->
                <div id="profile-view">
                    <div class="space-y-4">
                        <div><p class="text-sm text-gray-500">نام</p><p id="profile-firstname-view" class="text-lg font-semibold"></p></div>
                        <div><p class="text-sm text-gray-500">نام خانوادگی</p><p id="profile-lastname-view" class="text-lg font-semibold"></p></div>
                        <div><p class="text-sm text-gray-500">ایمیل</p><p id="profile-email-view" class="text-lg font-semibold text-gray-400"></p></div>
                        <div><p class="text-sm text-gray-500">سن</p><p id="profile-age-view" class="text-lg font-semibold"></p></div>
                        <div><p class="text-sm text-gray-500">جنسیت</p><p id="profile-gender-view" class="text-lg font-semibold"></p></div>
                    </div>
                    <button onclick="toggleProfileEdit(true)" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-300">ویرایش پروفایل</button>
                </div>
                <!-- Edit Mode -->
                <div id="profile-edit" class="hidden">
                    <div class="space-y-4">
                        <div><label class="text-sm text-gray-500">نام</label><input id="profile-firstname-edit" type="text" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="text-sm text-gray-500">نام خانوادگی</label><input id="profile-lastname-edit" type="text" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div><label class="text-sm text-gray-500">سن</label><input id="profile-age-edit" type="number" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                        <div>
                            <label class="text-sm text-gray-500">جنسیت</label>
                            <select id="profile-gender-edit" class="w-full p-2 border border-gray-300 rounded-lg bg-white">
                                <option value="male">مرد</option>
                                <option value="female">زن</option>
                                <option value="other">ترجیح می‌دهم نگویم</option>
                            </select>
                        </div>
                    </div>
                    <p id="profile-save-error" class="text-red-500 text-sm mt-2 h-4 text-center"></p>
                    <div class="flex gap-4 mt-6">
                        <button id="profile-save-button" onclick="saveProfile()" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">ذخیره تغییرات</button>
                        <button onclick="toggleProfileEdit(false)" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-300">انصراف</button>
                    </div>
                </div>
            </main>
        </div>


        <!-- Results Screen -->
        <div id="results-screen" class="hidden fade-in">
             <header class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-teal-600">داشبورد نتایج شما</h1>
                    <p id="results-username" class="text-gray-500 mt-1"></p>
                </div>
                 <div>
                    <button onclick="showProfile()" class="text-sm bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 mr-4">پروفایل</button>
                    <button onclick="startTest()" class="text-sm bg-teal-100 text-teal-700 font-semibold py-2 px-4 rounded-lg hover:bg-teal-200 mr-4">شروع مجدد آزمون</button>
                    <button onclick="logoutUser()" class="text-sm text-red-500 hover:underline">خروج</button>
                </div>
            </header>
            
            <!-- Tabs -->
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button onclick="changeTab(this, 'summary-tab')" class="tab-button active w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm">خلاصه و نمودار</button>
                    <button onclick="changeTab(this, 'details-tab')" class="tab-button w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">تحلیل دقیق ویژگی‌ها</button>
                    <button onclick="changeTab(this, 'history-tab')" class="tab-button w-1/3 py-4 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">تاریخچه آزمون‌ها</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="summary-tab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4 text-center">نیمرخ شخصیتی</h3>
                        <canvas id="results-chart"></canvas>
                    </div>
                    <div id="ai-summary-container" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 space-y-4">
                        <div>
                            <h3 class="text-xl font-bold mb-2">خلاصه کلی شخصیت (تحلیل هوشمند)</h3>
                            <p id="ai-general-summary" class="text-gray-600 leading-relaxed"></p>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">نقاط قوت بالقوه</h3>
                            <ul id="ai-strengths" class="list-disc list-inside text-gray-600 space-y-1"></ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">زمینه‌های قابل توسعه</h3>
                            <ul id="ai-challenges" class="list-disc list-inside text-gray-600 space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div id="details-tab" class="tab-content hidden">
                 <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
            <div id="history-tab" class="tab-content hidden">
                <div id="history-section" class="bg-white p-4 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-bold mb-3">تاریخچه آزمون‌ها</h3>
                    <p id="history-loading" class="text-gray-500">در حال بارگذاری سوابق...</p>
                    <ul id="history-list" class="space-y-2 max-h-96 overflow-y-auto"></ul>
                </div>
            </div>

            <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-bold mb-4">ابزارها</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                     <button id="pdf-button" class="w-full sm:w-auto flex-1 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors">دانلود گزارش PDF</button>
                     <button onclick="document.getElementById('api-key-modal').classList.remove('hidden')" class="w-full sm:w-auto flex-1 bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 transition-colors">تنظیمات هوش مصنوعی</button>
                     <button onclick="document.getElementById('feedback-modal').classList.remove('hidden')" class="w-full sm:w-auto flex-1 bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors">ارسال بازخورد</button>
                </div>
            </div>
        </div>
        
        <!-- API Key Modal -->
        <div id="api-key-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
            <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md fade-in">
                 <h3 class="text-xl font-bold mb-4">تنظیم کلید API هوش مصنوعی</h3>
                 <p class="text-gray-600 mb-4 text-sm">برای استفاده از تحلیل هوشمند، کلید API خود را از <a href="https://platform.openai.com/api-keys" target="_blank" class="text-teal-600 hover:underline">OpenAI</a> دریافت کرده و در کادر زیر وارد کنید.</p>
                 <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-500">کلید API</label>
                        <input id="api-key-input" type="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="sk-...">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">هاست API (اختیاری)</label>
                        <input id="api-host-input" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="https://api.openai.com">
                    </div>
                 </div>
                 <p id="api-key-error" class="text-red-500 text-sm mt-2 h-4"></p>
                 <div class="flex gap-4 mt-4">
                    <button id="save-api-key-button" onclick="saveApiKeyAndRetryAnalysis()" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">ذخیره و تلاش مجدد</button>
                    <button onclick="document.getElementById('api-key-modal').classList.add('hidden')" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-300">انصراف</button>
                 </div>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
            <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md fade-in">
                 <h3 class="text-xl font-bold mb-4">بازخورد شما برای ما ارزشمند است</h3>
                 <textarea id="feedback-text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" rows="4" placeholder="نظر خود را اینجا بنویسید..."></textarea>
                 <div class="flex gap-4 mt-4">
                    <button onclick="submitFeedback()" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">ارسال</button>
                    <button onclick="document.getElementById('feedback-modal').classList.add('hidden')" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg hover:bg-gray-300">انصراف</button>
                 </div>
            </div>
        </div>

        <!-- Thank You Screen -->
        <div id="thank-you-screen" class="hidden text-center fade-in p-8">
            <h2 class="text-3xl font-bold text-green-500">متشکریم!</h2>
            <p class="text-gray-600 mt-3 text-lg">بازخورد شما با موفقیت ثبت شد.</p>
             <button onclick="showScreen('results-screen')" class="mt-8 bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">بازگشت به نتایج</button>
        </div>
    </div>

    <!-- App Logic -->
    <script type="module">
        const { createClient } = supabase;

        // --- GLOBAL STATE & CONFIG ---
        let supabaseClient;
        let currentUser = null;
        let currentTestAnswers = [];
        let currentQuestionIndex = 0;
        let resultsChartInstance = null;
        let currentDisplayedTest = null;
        let analysisController; // AbortController for AI fetch
        
        // --- NEO-FFI 60 Questions ---
        const questions = [
            { text: "من آدم نگرانی نیستم.", trait: "N", R: true }, { text: "من به ندرت احساس ترس یا اضطراب می‌کنم.", trait: "N", R: true }, { text: "من اغلب احساس می‌کنم که در آستانه فروپاشی هستم.", trait: "N" }, { text: "من به ندرت احساس تنهایی یا غم می‌کنم.", trait: "N", R: true }, { text: "من اغلب عصبانی و خشمگین می‌شوم.", trait: "N" }, { text: "من اغلب احساس درماندگی می‌کنم و دلم می‌خواهد کسی مشکلاتم را حل کند.", trait: "N" }, { text: "من فردی آرام و خونسرد هستم.", trait: "N", R: true }, { text: "وقتی تحت فشار زیاد هستم، گاهی احساس می‌کنم دارم از هم می‌پاشم.", trait: "N" }, { text: "من به ندرت احساس خجالت یا دستپاچگی می‌کنم.", trait: "N", R: true }, { text: "من خیلی هیجانی هستم و احساساتم به راحتی جریحه‌دار می‌شود.", trait: "N" }, { text: "من اغلب از نحوه برخورد دیگران با خودم ناراحت می‌شوم.", trait: "N" }, { text: "من در برابر استرس آسیب‌پذیر هستم.", trait: "N" }, { text: "من از صحبت کردن با مردم لذت می‌برم.", trait: "E" }, { text: "من دوست دارم افراد زیادی دور و برم باشند.", trait: "E" }, { text: "من واقعاً از بودن در کنار دیگران لذت می‌برم.", trait: "E" }, { text: "من در جمع‌ها خودم را کنار می‌کشم.", trait: "E", R: true }, { text: "من در مهمانی‌ها و گردهمایی‌ها زیاد حرف نمی‌زنم.", trait: "E", R: true }, { text: "من دوست ندارم در مرکز توجه باشم.", trait: "E", R: true }, { text: "من آدم بشاش و سرحالی هستم.", trait: "E" }, { text: "من دوست دارم کارها را با دیگران انجام دهم تا به تنهایی.", trait: "E" }, { text: "من آدم شادی هستم.", trait: "E" }, { text: "من دوست دارم همیشه مشغول باشم و کارهای زیادی برای انجام دادن داشته باشم.", trait: "E" }, { text: "من به راحتی با دیگران دوست می‌شوم.", trait: "E" }, { text: "من همیشه مشتاقانه به دنبال هیجان هستم.", trait: "E" }, { text: "من تخیل بسیار فعالی دارم.", trait: "O" }, { text: "من سعی می‌کنم تمام افکارم را بر اساس واقعیت قرار دهم و از خیال‌پردازی دوری کنم.", trait: "O", R: true }, { text: "من علاقه‌ای به بحث‌های نظری یا انتزاعی ندارم.", trait: "O", R: true }, { text: "من از حل مسائل پیچیده و معماها لذت می‌برم.", trait: "O" }, { text: "زیبایی در هنر و طبیعت برای من اهمیت زیادی دارد.", trait: "O" }, { text: "من کنجکاو هستم و دوست دارم چیزهای جدید یاد بگیرم.", trait: "O" }, { text: "من ایده‌های جدید و غیرمتعارف را جالب می‌دانم.", trait: "O" }, { text: "من احساسات و عواطف خودم را به خوبی می‌شناسم.", trait: "O" }, { text: "من معتقدم که باید در مورد مسائل اخلاقی انعطاف‌پذیر بود.", trait: "O" }, { text: "من ترجیح می‌دهم کارهایم را به روش‌های آشنا و همیشگی انجام دهم.", trait: "O", R: true }, { text: "من از بازدید از موزه‌های هنری لذت می‌برم.", trait: "O" }, { text: "من اغلب از غذاهای جدید و خارجی امتحان می‌کنم.", trait: "O" }, { text: "من سعی می‌کنم با دیگران مهربان باشم.", trait: "A" }, { text: "من فکر می‌کنم اکثر مردم اساساً نیت خوبی دارند.", trait: "A" }, { text: "من به دیگران اعتماد دارم.", trait: "A" }, { text: "من تمایل دارم نسبت به دیگران بدبین و شکاک باشم.", trait: "A", R: true }, { text: "من به ندرت با دیگران جر و بحث می‌کنم.", trait: "A" }, { text: "گاهی اوقات دیگران را فریب می‌دهم تا به خواسته‌هایم برسم.", trait: "A", R: true }, { text: "من آدم سرسختی نیستم و به راحتی کوتاه می‌آیم.", trait: "A" }, { text: "من از همکاری با دیگران لذت می‌برم.", trait: "A" }, { text: "من می‌توانم تندخو و تحریک‌پذیر باشم.", trait: "A", R: true }, { text: "من برای دیگران دلسوزی می‌کنم.", trait: "A" }, { text: "برخی فکر می‌کنند من خودخواه و مغرور هستم.", trait: "A", R: true }, { text: "من ترجیح می‌دهم با دیگران رقابت کنم تا همکاری.", trait: "A", R: true }, { text: "من آدم منظمی هستم و دوست دارم همه چیز مرتب باشد.", trait: "C" }, { text: "من اغلب وسایلم را گم می‌کنم یا جایشان را فراموش می‌کنم.", trait: "C", R: true }, { text: "من سخت‌کوش و با پشتکار هستم.", trait: "C" }, { text: "من گاهی آنقدر که باید قابل اعتماد و مسئولیت‌پذیر نیستم.", trait: "C", R: true }, { text: "من فردی بسیار منضبط هستم.", trait: "C" }, { text: "من در شروع کارها مشکل دارم.", trait: "C", R: true }, { text: "من همیشه وظایفم را به موقع انجام می‌دهم.", trait: "C" }, { text: "من اهداف روشنی دارم و برای رسیدن به آنها به طور منظم تلاش می‌کنم.", trait: "C" }, { text: "من در تصمیم‌گیری‌ها محتاط و دقیق هستم.", trait: "C" }, { text: "من بدون فکر عمل می‌کنم.", trait: "C", R: true }, { text: "من به توانایی‌هایم برای انجام موفقیت‌آمیز کارها اطمینان دارم.", trait: "C" }, { text: "من کارهایم را نیمه‌کاره رها می‌کنم.", trait: "C", R: true }
        ];

        const traitDetails = {
            N: { name: "روان‌رنجوری", color: "red-500", description: "تمایل به تجربه هیجانات منفی مانند خشم، اضطراب یا افسردگی." }, 
            E: { name: "برون‌گرایی", color: "yellow-500", description: "تمایل به اجتماعی بودن، قاطعیت و تجربه هیجانات مثبت." }, 
            O: { name: "گشودگی", color: "blue-500", description: "میزان کنجکاوی، خلاقیت و قدردانی از هنر و تجربیات جدید." }, 
            A: { name: "توافق‌پذیری", color: "green-500", description: "تمایل به دلسوزی و همکاری به جای سوءظن و خصومت." }, 
            C: { name: "وظیفه‌شناسی", color: "purple-500", description: "تمایل به منظم بودن، قابل اعتماد بودن و داشتن اراده قوی." }
        };
        
        const traitInterpretations = {
            N: { low: "نمره پایین در روان‌رنجوری نشان‌دهنده ثبات هیجانی بالاست. شما احتمالاً فردی آرام، خونسرد و مقاوم در برابر استرس هستید و به ندرت احساس غم یا نگرانی می‌کنید.", medium: "نمره متوسط نشان‌دهنده تعادل هیجانی است. شما به طور کلی آرام هستید، اما در موقعیت‌های استرس‌زا به طور طبیعی هیجانات منفی را تجربه می‌کنید.", high: "نمره بالا در روان‌رنجوری ممکن است به این معنا باشد که شما نسبت به دیگران هیجانات منفی بیشتری مانند اضطراب، خشم یا غم را تجربه می‌کنید و در برابر استرس حساس‌تر هستید." },
            E: { low: "نمره پایین در برون‌گرایی (درون‌گرایی) به این معناست که شما احتمالاً فردی تودار، مستقل و کم‌حرف هستید. از تنهایی لذت می‌برید و تعاملات اجتماعی گسترده انرژی شما را تحلیل می‌برد.", medium: "نمره متوسط نشان‌دهنده تعادل بین برون‌گرایی و درون‌گرایی است. شما هم از بودن در جمع لذت می‌برید و هم به زمان تنهایی برای بازیابی انرژی نیاز دارید.", high: "نمره بالا در برون‌گرایی نشان می‌دهد که شما فردی اجتماعی، پرانرژی و قاطع هستید. از بودن در مرکز توجه و تعامل با دیگران لذت می‌برید و انرژی خود را از جمع می‌گیرید." },
            O: { low: "نمره پایین در گشودگی نشان می‌دهد که شما فردی عمل‌گرا، سنتی و واقع‌بین هستید. ترجیح می‌دهید کارها را به روش‌های آشنا انجام دهید و به ایده‌های ملموس بیشتر از مفاهیم انتزاعی علاقه دارید.", medium: "نمره متوسط نشان‌دهنده تعادل بین کنجکاوی و عمل‌گرایی است. شما برای ایده‌های جدید ارزش قائل هستید اما در عین حال رویکردی واقع‌بینانه به زندگی دارید.", high: "نمره بالا در گشودگی به تجربه نشان‌دهنده خلاقیت، کنجکاوی و ذهن باز شماست. شما از هنر، ماجراجویی، ایده‌های غیرمتعارف و تجربیات جدید لذت می‌برید." },
            A: { low: "نمره پایین در توافق‌پذیری ممکن است به این معنا باشد که شما فردی رقابت‌جو، قاطع و گاهی شکاک هستید. منافع خود را در اولویت قرار می‌دهید و از تقابل و بحث ابایی ندارید.", medium: "نمره متوسط نشان‌دهنده تعادل بین همکاری و رقابت است. شما به طور کلی مهربان هستید اما در صورت لزوم می‌توانید از حقوق و نظرات خود دفاع کنید.", high: "نمره بالا در توافق‌پذیری نشان می‌دهد که شما فردی دلسوز، مهربان و اهل همکاری هستید. به دیگران اعتماد دارید و تمایل دارید از درگیری اجتناب کنید." },
            C: { low: "نمره پایین در وظیفه‌شناسی نشان می‌دهد که شما فردی انعطاف‌پذیر، خودجوش و شاید کمی بی‌نظم هستید. ممکن است در پایبندی به برنامه‌ها و شروع کارها با چالش مواجه شوید.", medium: "نمره متوسط نشان‌دهنده تعادل بین نظم و انعطاف‌پذیری است. شما به طور کلی قابل اعتماد هستید اما سخت‌گیری بیش از حد ندارید و می‌توانید خود را با شرایط وفق دهید.", high: "نمره بالا در وظیفه‌شناسی نشان می‌دهد که شما فردی منظم، قابل اعتماد و با اراده هستید. اهداف مشخصی دارید و برای رسیدن به آنها با پشتکار تلاش می‌کنید." }
        };


        // --- UI MANAGEMENT ---
        const screens = ['loading-screen', 'welcome-screen', 'register-screen', 'login-screen', 'test-screen', 'analyzing-screen', 'results-screen', 'profile-screen', 'thank-you-screen'];

        function showScreen(screenId) {
            screens.forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); });
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) activeScreen.classList.remove('hidden');
        }
        
        function toggleButtonSpinner(buttonId, show) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            if (show) {
                button.disabled = true;
                button.innerHTML = `<div class="btn-spinner"></div>`;
            } else {
                button.disabled = false;
                if (buttonId === 'register-button') button.textContent = 'ثبت نام';
                if (buttonId === 'login-button') button.textContent = 'ورود';
                if (buttonId === 'profile-save-button') button.textContent = 'ذخیره تغییرات';
            }
        }

        // --- SUPABASE & AUTHENTICATION ---
        function initializeSupabase() {
            const SUPABASE_URL = 'https://dlzgqcalzldezrfdxzqf.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsemdxY2FsemxkZXpyZmR4enFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzAzMDIsImV4cCI6MjA3MDkwNjMwMn0.NIRIMNmtAqGreHIfFPPpxYjggeoxWklElwOMoh2c_6o';
            
            try {
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                setupAuthListener();
            } catch (error) {
                console.error("Supabase initialization failed:", error);
                document.getElementById('init-error').textContent = `خطا در راه‌اندازی Supabase: ${error.message}`;
            }
        }

        async function setupAuthListener() {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                try {
                    const user = session?.user;

                    if (user) {
                        let { data: profile, error } = await supabaseClient
                            .from('profiles')
                            .select('*')
                            .eq('id', user.id)
                            .single();

                        if (error && error.code === 'PGRST116') { // Profile not found
                            console.log("Profile not found, creating one...");
                            
                            const meta = user.user_metadata;
                            const [firstname, ...lastnameParts] = (meta.full_name || '').split(' ');
                            const lastname = lastnameParts.join(' ');

                            const profileData = {
                                id: user.id,
                                email: user.email,
                                firstname: meta.firstname || firstname || '',
                                lastname: meta.lastname || lastname || '',
                                age: meta.age || null,
                                gender: meta.gender || null
                            };

                            const { data: newProfile, error: insertError } = await supabaseClient
                                .from('profiles')
                                .insert(profileData)
                                .select()
                                .single();
                            
                            if (insertError) throw insertError;
                            profile = newProfile;
                        } else if (error) {
                            throw error;
                        }
                        
                        currentUser = profile;
                        
                        const { data: results, error: resultsError } = await supabaseClient
                            .from('results')
                            .select('*')
                            .eq('user_id', currentUser.id)
                            .order('completed_at', { ascending: false });

                        if (resultsError) throw resultsError;

                        if (results && results.length > 0) {
                            const latestTest = results[0];
                            displayResults(latestTest.scores, latestTest.ai_analysis, latestTest.id);
                        } else {
                            startTest();
                        }
                    } else {
                        currentUser = null;
                        showScreen('welcome-screen');
                    }
                } catch (error) {
                    console.error("Critical error in auth state change:", error);
                    document.getElementById('welcome-error').textContent = "خطا در بازیابی جلسه. لطفاً دوباره وارد شوید.";
                    await supabaseClient.auth.signOut();
                    showScreen('welcome-screen');
                }
            });
        }
        
        window.registerUser = async () => {
            const firstname = document.getElementById('register-firstname').value.trim();
            const lastname = document.getElementById('register-lastname').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const age = document.getElementById('register-age').value;
            const gender = document.getElementById('register-gender').value;
            const errorEl = document.getElementById('register-error');

            if (!firstname || !lastname || !email || !password || !age || !gender) {
                errorEl.textContent = 'لطفاً تمام فیلدها را پر کنید.';
                return;
            }
            errorEl.textContent = '';
            toggleButtonSpinner('register-button', true);

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            firstname,
                            lastname,
                            age: parseInt(age),
                            gender
                        }
                    }
                });
                if (error) throw error;
                alert("ثبت نام موفقیت آمیز بود. لطفاً ایمیل خود را برای تایید حساب کاربری بررسی کنید.");
                showScreen('login-screen');

            } catch (error) {
                console.error("Registration error:", error);
                errorEl.textContent = error.message || 'خطا در ثبت نام.';
            } finally {
                toggleButtonSpinner('register-button', false);
            }
        };

        window.loginUser = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            if (!email || !password) {
                errorEl.textContent = 'لطفاً ایمیل و رمز عبور را وارد کنید.';
                return;
            }
            errorEl.textContent = '';
            toggleButtonSpinner('login-button', true);

            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
            } catch (error) {
                 console.error("Login error:", error);
                 if (error.message.includes("Invalid login credentials")) {
                    errorEl.textContent = 'ایمیل یا رمز عبور وارد شده صحیح نیست.';
                 } else {
                    errorEl.textContent = 'خطا در ورود. لطفاً اتصال اینترنت را بررسی کنید.';
                 }
            } finally {
                toggleButtonSpinner('login-button', false);
            }
        };

        window.signInWithGoogle = async () => {
            try {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                });
                if (error) throw error;
            } catch (error) {
                console.error("Google Sign-In Error", error);
                alert(`خطا در ورود با گوگل: ${error.message}`);
            }
        };


        window.logoutUser = async () => {
            try { 
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
            } 
            catch (error) { console.error("Logout error:", error); }
        };

        // --- TEST LOGIC ---
        window.startTest = () => {
            currentQuestionIndex = 0;
            currentTestAnswers = [];
            showScreen('test-screen');
            renderQuestion();
        }

        function renderQuestion() {
            if (currentQuestionIndex >= questions.length) {
                finishTest();
                return;
            }

            const question = questions[currentQuestionIndex];
            const container = document.getElementById('question-container');
            const counter = document.getElementById('question-counter');
            const progressBar = document.getElementById('progress-bar');
            
            counter.textContent = `سوال ${currentQuestionIndex + 1} از ${questions.length}`;
            progressBar.style.width = `${((currentQuestionIndex) / questions.length) * 100}%`;

            const options = [
                { text: 'کاملاً مخالفم', value: 0 }, { text: 'مخالفم', value: 1 }, { text: 'نظری ندارم', value: 2 }, { text: 'موافقم', value: 3 }, { text: 'کاملاً موافقم', value: 4 }
            ];
            const colors = ['bg-red-200 hover:bg-red-300', 'bg-orange-200 hover:bg-orange-300', 'bg-gray-200 hover:bg-gray-300', 'bg-lime-200 hover:bg-lime-300', 'bg-green-200 hover:bg-green-300'];
            const textColors = ['text-red-800', 'text-orange-800', 'text-gray-800', 'text-lime-800', 'text-green-800'];

            container.innerHTML = `
                <p class="text-xl text-center font-semibold mb-6 h-16 flex items-center justify-center">${question.text}</p>
                <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-3 flex-wrap">
                    ${options.map((opt, index) => `
                        <button class="w-full sm:w-auto flex-1 font-medium py-3 px-4 rounded-lg border-2 border-transparent focus:outline-none transition-all ${colors[index]} ${textColors[index]}" onclick="selectAnswer(${opt.value}, this)">
                            ${opt.text}
                        </button>
                    `).join('')}
                </div>
            `;
            document.getElementById('next-button').disabled = true;
        }

        window.selectAnswer = (value, selectedButton) => {
            currentTestAnswers[currentQuestionIndex] = value;
            const buttons = document.querySelectorAll('#question-container button');
            buttons.forEach(btn => { btn.classList.remove('ring-4', 'ring-teal-400'); });
            selectedButton.classList.add('ring-4', 'ring-teal-400');
            document.getElementById('next-button').disabled = false;
        }

        window.nextQuestion = () => {
            currentQuestionIndex++;
             if (currentQuestionIndex === questions.length) { document.getElementById('progress-bar').style.width = '100%'; }
            renderQuestion();
        }

        async function finishTest() {
            showScreen('analyzing-screen');
            const scores = calculateScores();
            
            const apiKey = localStorage.getItem('openaiApiKey');
            if (!apiKey) {
                document.getElementById('api-key-modal').classList.remove('hidden');
                await saveResults(scores, {});
                const latestTest = await getLatestTest();
                displayResults(latestTest.scores, {}, latestTest.id, "برای تحلیل هوشمند، لطفاً کلید API خود را وارد کنید.");
                return;
            }

            const aiResult = await getAIAnalysis(scores);
            await saveResults(scores, aiResult.analysis);
            const latestTest = await getLatestTest();
            displayResults(latestTest.scores, latestTest.ai_analysis, latestTest.id, aiResult.errorMessage);
        }

        // --- RESULTS & AI ANALYSIS ---
        function calculateScores() {
            const scores = { N: 0, E: 0, O: 0, A: 0, C: 0 };
            const counts = { N: 0, E: 0, O: 0, A: 0, C: 0 };

            questions.forEach((q, index) => {
                let value = currentTestAnswers[index];
                if (q.R) value = 4 - value;
                scores[q.trait] += value;
                counts[q.trait]++;
            });
            
            for (const trait in scores) {
                const maxScore = counts[trait] * 4;
                scores[trait] = Math.round((scores[trait] / maxScore) * 100);
            }
            return scores;
        }

        async function getAIAnalysis(scores) {
            const apiKey = localStorage.getItem('openaiApiKey');
            const apiHost = localStorage.getItem('openaiApiHost') || 'https://api.openai.com';
            
            if (!apiKey) {
                 return { analysis: {}, errorMessage: "کلید API برای هوش مصنوعی تنظیم نشده است." };
            }

            analysisController = new AbortController();
            const timeoutId = setTimeout(() => analysisController.abort(), 30000); // 30-second timeout

            const apiUrl = `${apiHost}/v1/chat/completions`;
            const prompt = `You are a professional psychologist analyzing a user's Big Five personality scores. Provide a comprehensive, structured analysis in Persian. The response MUST be a valid JSON object with the following structure:
                {
                  "generalSummary": "A holistic paragraph summarizing the user's overall personality profile based on the interaction of their traits.",
                  "strengths": [
                    "A potential strength based on their score profile.",
                    "Another potential strength.",
                    "A third potential strength."
                  ],
                  "challenges": [
                    "A potential area for development or awareness.",
                    "Another potential area for development."
                  ],
                  "detailedAnalysis": {
                    "N": "A brief interpretation of the Neuroticism score.",
                    "E": "A brief interpretation of the Extraversion score.",
                    "O": "A brief interpretation of the Openness score.",
                    "A": "A brief interpretation of the Agreeableness score.",
                    "C": "A brief interpretation of the Conscientiousness score."
                  }
                }
                Use a supportive and insightful tone. Scores are out of 100.
                Scores: N: ${scores.N}, E: ${scores.E}, O: ${scores.O}, A: ${scores.A}, C: ${scores.C}`;
            
            const payload = {
                model: "gpt-4o-mini",
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" }
            };
            
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    }, 
                    body: JSON.stringify(payload),
                    signal: analysisController.signal
                });
                
                clearTimeout(timeoutId);
                const result = await response.json();

                if (!response.ok) {
                    console.error("API Error Response:", result);
                    const detail = result.error?.message || `وضعیت ${response.status}`;
                    return { analysis: {}, errorMessage: `خطا از سرور هوش مصنوعی: ${detail}` };
                }
                
                const analysis = JSON.parse(result.choices[0].message.content);
                return { analysis, errorMessage: null };

            } catch (error) {
                clearTimeout(timeoutId);
                console.error("Fetch/AI analysis failed:", error);
                if (error.name === 'AbortError') {
                    return { analysis: {}, errorMessage: "پاسخی از سرور هوش مصنوعی دریافت نشد (Timeout). لطفاً اتصال و آدرس هاست را بررسی کنید." };
                }
                let message = "خطای شبکه یا CORS. لطفاً اتصال اینترنت و کنسول مرورگر را بررسی کنید.";
                if (error instanceof TypeError) {
                    message = "خطای شبکه یا محدودیت مرورگر (CORS). لطفاً اتصال اینترنت خود را بررسی کنید.";
                }
                return { analysis: {}, errorMessage: message };
            }
        }
        
        window.cancelAnalysis = async () => {
            if (analysisController) {
                analysisController.abort();
            }
            // We still need to show the results page without the analysis
            const latestTest = await getLatestTest();
            if (latestTest) {
                displayResults(latestTest.scores, latestTest.ai_analysis, latestTest.id, "عملیات تحلیل توسط کاربر لغو شد.");
            } else {
                showScreen('welcome-screen');
            }
        };


        async function saveResults(scores, aiAnalysis) {
            if (!currentUser) return;
            const { error } = await supabaseClient
                .from('results')
                .insert({ 
                    user_id: currentUser.id, 
                    scores, 
                    ai_analysis: aiAnalysis 
                });
            if (error) throw error;
        }
        
        async function getLatestTest() {
            const { data, error } = await supabaseClient
                .from('results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('completed_at', { ascending: false })
                .limit(1)
                .single();
            if (error) {
                console.error("Could not get latest test:", error);
                return null;
            }
            return data;
        }

        function displayResults(scores, aiAnalysis = {}, activeTestId, aiErrorMessage = null) {
            currentDisplayedTest = { scores, aiAnalysis };
            const usernameEl = document.getElementById('results-username');
            if (currentUser.firstname && currentUser.lastname) {
                usernameEl.innerHTML = `تحلیل برای: ${currentUser.firstname} ${currentUser.lastname}`;
            } else {
                usernameEl.innerHTML = `برای شخصی‌سازی گزارش، لطفاً <button class='text-teal-600 underline font-bold' onclick='showProfile()'>پروفایل خود را تکمیل کنید</button>.`;
            }
            
            renderSummaryTab(scores, aiAnalysis, aiErrorMessage);
            renderDetailsTab(scores, aiAnalysis, aiErrorMessage);
            displayTestHistory(activeTestId);
            
            showScreen('results-screen');
            changeTab(document.querySelector('.tab-button'), 'summary-tab');
        }

        function renderSummaryTab(scores, aiAnalysis, aiErrorMessage) {
            renderRadarChart(scores);
            const summaryEl = document.getElementById('ai-general-summary');
            const strengthsEl = document.getElementById('ai-strengths');
            const challengesEl = document.getElementById('ai-challenges');
            
            const displayError = (el, message) => {
                el.innerHTML = `<li class="text-red-500">${message}</li>`;
            };

            if (aiErrorMessage) {
                summaryEl.textContent = aiErrorMessage;
                summaryEl.classList.add('text-red-500');
                displayError(strengthsEl, 'تحلیل در دسترس نیست.');
                displayError(challengesEl, 'تحلیل در دسترس نیست.');
                return;
            }

            summaryEl.textContent = aiAnalysis?.generalSummary || "خلاصه کلی تحلیل هوشمند در دسترس نیست.";
            summaryEl.classList.toggle('text-red-500', !aiAnalysis?.generalSummary);

            strengthsEl.innerHTML = '';
            if (aiAnalysis?.strengths?.length > 0) {
                aiAnalysis.strengths.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    strengthsEl.appendChild(li);
                });
            } else {
                displayError(strengthsEl, 'تحلیل در دسترس نیست.');
            }

            challengesEl.innerHTML = '';
            if (aiAnalysis?.challenges?.length > 0) {
                aiAnalysis.challenges.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    challengesEl.appendChild(li);
                });
            } else {
                displayError(challengesEl, 'تحلیل در دسترس نیست.');
            }
        }


        function renderDetailsTab(scores, aiAnalysis, aiErrorMessage) {
             const container = document.getElementById('results-container');
             container.innerHTML = '';

            for (const trait in scores) {
                const details = traitDetails[trait];
                const score = scores[trait];
                
                const isAiAnalysisAvailable = aiAnalysis?.detailedAnalysis && aiAnalysis.detailedAnalysis[trait];
                let analysisText = isAiAnalysisAvailable ? aiAnalysis.detailedAnalysis[trait] : (aiErrorMessage || "تحلیل هوشمند در دسترس نیست.");

                let scoreLevel;
                if (score < 35) scoreLevel = 'low';
                else if (score <= 65) scoreLevel = 'medium';
                else scoreLevel = 'high';
                const interpretationText = traitInterpretations[trait][scoreLevel];

                const card = `
                    <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 fade-in">
                        <h3 class="font-bold text-lg text-gray-800">${details.name}</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4 my-2">
                            <div class="bg-${details.color} h-4 rounded-full" style="width: ${score}%"></div>
                        </div>
                        <p class="text-right font-bold text-gray-700">${score} از ۱۰۰</p>
                        <div class="mt-4 pt-4 border-t border-gray-200 space-y-3">
                             <div><h4 class="font-semibold text-gray-700 mb-1">تفسیر نمره</h4><p class="text-sm text-gray-600 leading-relaxed">${interpretationText}</p></div>
                             <div><h4 class="font-semibold text-teal-700 mb-1">تحلیل هوشمند</h4><p class="text-sm leading-relaxed ${isAiAnalysisAvailable ? 'text-gray-600' : 'text-red-500'}">${analysisText}</p></div>
                        </div>
                    </div>`;
                container.innerHTML += card;
            }
        }
        
        async function displayTestHistory(activeTestId) {
            const historyList = document.getElementById('history-list');
            const historyLoading = document.getElementById('history-loading');
            historyList.innerHTML = '';
            historyLoading.textContent = 'در حال بارگذاری سوابق...';
            historyLoading.classList.remove('hidden');

            const { data: history, error } = await supabaseClient
                .from('results')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('completed_at', { ascending: false });

            if (error) {
                console.error("Error fetching history:", error);
                historyLoading.textContent = 'خطا در دریافت سوابق.';
                return;
            }

            if (!history || history.length === 0) {
                historyLoading.textContent = 'سابقه‌ای یافت نشد.';
                return;
            }

            historyLoading.classList.add('hidden');
            history.forEach(testData => {
                const testId = testData.id;
                const date = new Date(testData.completed_at).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                const li = document.createElement('li');
                li.innerHTML = `<button class="w-full text-right p-3 rounded-lg transition-colors ${testId === activeTestId ? 'bg-teal-100 text-teal-800 font-bold' : 'hover:bg-gray-100'}">آزمون ثبت شده در: ${date}</button>`;
                li.querySelector('button').onclick = () => loadSpecificTest(testId);
                historyList.appendChild(li);
            });
        }

        async function loadSpecificTest(testId) {
            const { data: testData, error } = await supabaseClient
                .from('results')
                .select('*')
                .eq('id', testId)
                .single();

            if (error) {
                alert("خطا: سابقه آزمون مورد نظر یافت نشد.");
                return;
            }
            displayResults(testData.scores, testData.ai_analysis, testId);
        }

        function renderRadarChart(scores) {
            const ctx = document.getElementById('results-chart').getContext('2d');
            const labels = Object.keys(scores).map(trait => traitDetails[trait].name);
            const data = Object.values(scores);

            if (resultsChartInstance) { resultsChartInstance.destroy(); }

            resultsChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'نمرات شما', data: data, backgroundColor: 'rgba(20, 184, 166, 0.2)', borderColor: 'rgba(13, 148, 136, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(13, 148, 136, 1)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(13, 148, 136, 1)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: { r: { angleLines: { color: 'rgba(0, 0, 0, 0.1)' }, grid: { color: 'rgba(0, 0, 0, 0.1)' }, pointLabels: { font: { family: "'Vazirmatn', sans-serif", size: 12 }, color: '#374151' }, ticks: { backdropColor: 'rgba(255, 255, 255, 0.75)', color: '#6B7280', stepSize: 20 }, min: 0, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        window.saveApiKeyAndRetryAnalysis = async () => {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiHostInput = document.getElementById('api-host-input');
            const apiKey = apiKeyInput.value.trim();
            const apiHost = apiHostInput.value.trim();
            const errorEl = document.getElementById('api-key-error');

            if (!apiKey) {
                errorEl.textContent = 'لطفاً کلید API را وارد کنید.';
                return;
            }
            errorEl.textContent = '';
            localStorage.setItem('openaiApiKey', apiKey);
            localStorage.setItem('openaiApiHost', apiHost); // Save host even if empty
            document.getElementById('api-key-modal').classList.add('hidden');
            
            showScreen('analyzing-screen');
            const latestTest = await getLatestTest();
            const aiResult = await getAIAnalysis(latestTest.scores);

            const { error } = await supabaseClient
                .from('results')
                .update({ ai_analysis: aiResult.analysis })
                .eq('id', latestTest.id);
            if (error) throw error;

            displayResults(latestTest.scores, aiResult.analysis, latestTest.id, aiResult.errorMessage);
        };


        // --- FEEDBACK & PDF ---
        window.submitFeedback = async () => {
            const feedbackText = document.getElementById('feedback-text').value;
            if (!feedbackText.trim() || !currentUser) return;
            try {
                // Assuming a 'feedbacks' table exists
                const { error } = await supabaseClient
                    .from('feedbacks')
                    .insert({ user_id: currentUser.id, feedback: feedbackText });
                if (error) throw error;
                document.getElementById('feedback-modal').classList.add('hidden');
                showScreen('thank-you-screen');
            } catch (error) { console.error("Error submitting feedback:", error); }
        };
        
        document.getElementById('pdf-button').addEventListener('click', () => {
            if (currentDisplayedTest) {
                generatePDF(currentDisplayedTest.scores, currentDisplayedTest.aiAnalysis);
            } else {
                alert("لطفاً ابتدا یک آزمون را مشاهده کنید.");
            }
        });

        function generatePDF(scores, aiAnalysis) {
            if (!currentUser || !resultsChartInstance || !scores) return;
            const { jsPDF } = window.jspdf;
            const docPDF = new jsPDF();
            docPDF.text("NEO-PSY Personality Report", 105, 15, { align: 'center' });
            docPDF.text(`User: ${currentUser.firstname} ${currentUser.lastname}`, 105, 25, { align: 'center' });
            const chartImage = resultsChartInstance.toBase64Image();
            docPDF.addImage(chartImage, 'PNG', 40, 35, 130, 130);

            let content = [];
            for (const trait in scores) {
                let scoreLevel;
                if (scores[trait] < 35) scoreLevel = 'low';
                else if (scores[trait] <= 65) scoreLevel = 'medium';
                else scoreLevel = 'high';
                content.push([ traitDetails[trait].name, scores[trait].toString(), traitInterpretations[trait][scoreLevel] ]);
            }
            docPDF.autoTable({ head: [['Trait', 'Score', 'Interpretation']], body: content, startY: 175, styles: { font: 'helvetica' }, headStyles: { fillColor: [13, 148, 136] }, });
            
            docPDF.save(`neo-psy-report-${currentUser.id.substring(0,6)}.pdf`);
        };
        
        window.showProfile = () => {
            document.getElementById('profile-firstname-view').textContent = currentUser.firstname || 'هنوز وارد نشده';
            document.getElementById('profile-lastname-view').textContent = currentUser.lastname || 'هنوز وارد نشده';
            document.getElementById('profile-email-view').textContent = currentUser.email;
            document.getElementById('profile-age-view').textContent = currentUser.age || 'هنوز وارد نشده';
            document.getElementById('profile-gender-view').textContent = currentUser.gender || 'هنوز وارد نشده';
            toggleProfileEdit(false); // Ensure view mode is active
            showScreen('profile-screen');
        };
        
        window.toggleProfileEdit = (isEditing) => {
            document.getElementById('profile-view').classList.toggle('hidden', isEditing);
            document.getElementById('profile-edit').classList.toggle('hidden', !isEditing);
            if (isEditing) {
                document.getElementById('profile-firstname-edit').value = currentUser.firstname || '';
                document.getElementById('profile-lastname-edit').value = currentUser.lastname || '';
                document.getElementById('profile-age-edit').value = currentUser.age || '';
                document.getElementById('profile-gender-edit').value = currentUser.gender || '';
            }
        };

        window.saveProfile = async () => {
            const updatedData = {
                firstname: document.getElementById('profile-firstname-edit').value.trim(),
                lastname: document.getElementById('profile-lastname-edit').value.trim(),
                age: parseInt(document.getElementById('profile-age-edit').value),
                gender: document.getElementById('profile-gender-edit').value,
            };

            const errorEl = document.getElementById('profile-save-error');
            if (!updatedData.firstname || !updatedData.lastname || !updatedData.age || !updatedData.gender) {
                errorEl.textContent = 'لطفاً تمام فیلدها را تکمیل کنید.';
                return;
            }
            errorEl.textContent = '';
            toggleButtonSpinner('profile-save-button', true);

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(updatedData)
                    .eq('id', currentUser.id);
                if (error) throw error;
                
                currentUser = { ...currentUser, ...updatedData };
                showProfile(); // Refresh profile view
            } catch (error) {
                console.error("Error updating profile:", error);
                errorEl.textContent = 'خطا در ذخیره‌سازی اطلاعات.';
            } finally {
                toggleButtonSpinner('profile-save-button', false);
            }
        };

        window.changeTab = (button, tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            button.classList.add('active');
        };

        // --- INITIALIZATION ---
        window.showScreen = showScreen; window.loginUser = loginUser; window.registerUser = registerUser; window.logoutUser = logoutUser; window.startTest = startTest; window.selectAnswer = selectAnswer; window.nextQuestion = nextQuestion; window.submitFeedback = submitFeedback; window.loadSpecificTest = loadSpecificTest; window.saveApiKeyAndRetryAnalysis = saveApiKeyAndRetryAnalysis; window.showProfile = showProfile; window.changeTab = changeTab; window.toggleProfileEdit = toggleProfileEdit; window.saveProfile = saveProfile; window.signInWithGoogle = signInWithGoogle; window.cancelAnalysis = cancelAnalysis;
        document.addEventListener('DOMContentLoaded', initializeSupabase);

    </script>
</body>
</html>
